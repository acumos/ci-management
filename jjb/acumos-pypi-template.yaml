---
# Job definition Anchors
- pypi_job_boiler_plate: &pypi_job_boiler_plate
    name: pypi_job_boiler_plate

  project-type: freestyle
  node: '{build-node}'

  #####################
  # Default variables #
  #####################

  # This variable can be over written at the job level
  # pypi-server: staging

  #####################
  # Job configuration #
  #####################

  properties:
    - lf-infra-properties:
        build-days-to-keep: '{build-days-to-keep}'

  parameters:
    - lf-infra-parameters:
        project: '{project}'
        branch: '{branch}'
        stream: '{stream}'
        lftools-version: '{lftools-version}'

  scm:
    - lf-infra-gerrit-scm:
        jenkins-ssh-credential: '{jenkins-ssh-credential}'
        git-url: '{git-url}'
        refspec: '$GERRIT_REFSPEC'
        branch: '$GERRIT_BRANCH'
        submodule-recursive: '{submodule-recursive}'
        choosing-strategy: default

  wrappers:
    - lf-infra-wrappers:
        build-timeout: '{build-timeout}'
        jenkins-ssh-credential: '{jenkins-ssh-credential}'

  builders:
    - provide-maven-settings:
      global-settings-file: 'pypirc'
      settings-file: '{mvn-settings}'
    - shell: |
        #!/bin/bash
        virtualenv $WORKSPACE/venv-tox
        source $WORKSPACE/venv-tox/bin/activate
        pip install --upgrade pip
        pip install --upgrade tox argparse
        pip freeze
        cd $WORKSPACE/{path}
        tox
    - shell:
        !include-raw-escape: pypi-publish.sh

  publishers:
    - lf-infra-publish

  <<: *pypi_job_boiler_plate

- job-template:
    # Job template for PyPI staging jobs
    # Daily Builds

    name: '{project-name}-python-stage-{stream}'

    triggers:
      # 11:00am UTC
      - timed: 'H 11 * * *'
      - gerrit-trigger-patch-submitted:
          server: '{server-name}'
          project: '{project}'
          branch: '{branch}'

- job-template:
    # Job template for PyPI release jobs
    # Requires manual trigger

    name: '{project-name}-python-release-{stream}'

    triggers:
      - gerrit-trigger-release-manually:
          server: '{server-name}'
          project: '{project}'
          branch: '{branch}'
